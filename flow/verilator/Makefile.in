
#
# 1. Top module name
define map_vl_mdir
$(REPO_WORK)/verilator/${1}
endef

#
# 1. Top module name
define map_vl_exe
$(call map_vl_mdir,${1})/verilated-${1}
endef

#
# 1. Top module name
define map_vl_makefile
$(call map_vl_mdir,${1})/V${1}.mk
endef

#
# 1. Top Module Name
# 2. target command file
define add_vl_target

$(call map_vl_exe,${1}) : ${2}
	mkdir -p $(call map_vl_mdir,${1})
	$(VERILATOR) \
        -f ${2} \
        -o $(call map_vl_exe,${1}) \
        --Mdir $(call map_vl_mdir,${1}) \
        --top-module ${1}
	$(MAKE) -C $(call map_vl_mdir,${1}) -f $(call map_vl_makefile,${1})

build-${1}: $(call map_vl_exe,${1})

endef

CMD_CORE = $(REPO_HOME)/flow/verilator/cmd-core.txt
TOP_CORE = core_top
EXE_CORE = $(call map_vl_exe,$(TOP_CORE))

$(eval $(call add_vl_target,$(TOP_CORE),$(CMD_CORE)))

